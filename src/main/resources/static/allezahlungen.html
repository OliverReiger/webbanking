<!DOCTYPE html>
<html>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.5.0/Chart.min.js"></script>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="shortcut icon" type="image/x-icon" href="favicon.ico">
<link rel="stylesheet" href="myCSS.css" >
<!--   <script defer src="allezahlungen.js" type="module" type="text/javascript"></script>  -->



<style>
        th, td, p, input {
            font:14px Verdana;
        }
        table, th, td 
        {
            border: solid 1px #DDD;
            border-collapse: collapse;
            padding: 2px 3px;
            text-align: center;
        }
        th {
            font-weight:bold;
        }
    </style>
<title>Web-Banking</title>
</head>

<header id="header" class="floatbox">
	<div id="header-content">
  	<p>this tool is made with <img src="heart.png" alt="love" width="25" height="25"/> by SEA </p>
  	</div>
</header>

<body>

<div class="sidenav">
  <h2>Web-Banking</h2>
  <br/>
  <a href="/index.html">Home</a>
  <a href="/neuezahlung.html">Neue Zahlung</a>
  <a href="/einzelabfrage.html">Einzelabfrage</a>
  <a href="/allezahlungen.html">Übersicht Transaktionen</a>
  <a href="/testdaten.html">Zahlungen generieren</a>
  <!-- <a href="/?kdnr=1234">Login Kd.1</a> -->
  <!-- <a href="/?kdnr=2345">Login Kd.2</a> -->
  <a href="#tbd">Credits</a>
</div>

<div class="main">
	<br/>
    <h3>Übersicht Zahlungen</h3>
	<br/>	
	<div id=output></div>
	<p><span id="anzahl"> KLICKE <button id="btnA" type="button">ANZAHL</button>! </span> <span id="anzahl2"></span>  |  Kontostand: <span id="info"> KLICKE <button id="btnK" type="button">CHECK</button>! </span> Euro.</p>
	<br/>
	<br/>
	<div id=box>
	<canvas id="myChart1" style="width:100%;max-width:500px;max-height:500px"></canvas>
	</div>
	<br/>
	<div id=box>
	<canvas id="myChart2" style="width:100%;max-width:300px;max-height:300px"></canvas>
	</div >

</div> 
</body>

<script>
// Bei Start der Seite soll immer die Tabelle geladen werden
tabelleAusJson();

// GLOBALE VARIABLE FÜR DIE DYNAMISCHE TABELLE
var table = document.createElement("table");

// FUNKTIONSAUFRUF zum senden eines DELETE an WEBSERVER und entfernen 
// der Zeile aus der Tabelle - wird von tabelleAusJSON() aufgerufen
function loescheZelle(i) {
	fetch("/deleteZahlungDB/" + i,
			{
				headers: {"Content-Type":"application/json"},
				method: "DELETE",
				body: ""
			}
			).then(alert("Danke für die Nutzung unseres Webservices!"))
	
			//Seite und Tabelle aufgrund Autostart nach Löschvorgang neu laden
			location.reload();
		}

// FUNKTIONSAUFRUF zum abholen der json Daten über REST API und Erzeugung einer Tabelle
// Schritt 1: Vorbereitung des Abrufs und abholen der json
function tabelleAusJson() {
        fetch("/zahlungenDB")				// JSON abrufen
        .then(empfaenger1)					// Aufruf der Methode empfaenger1 (auspacken der JSON)
        .then(empfaenger2)					// Generierung der Tabelle
    }

// FUNKTIONSAUFRUF zum abholen der json Daten über REST API und Erzeugung einer Tabelle
// Schritt 2: Entgegennehmen der json und auspacken   
function empfaenger1(antwort) {
    var json = antwort.json();  			// Datenpaket auspacken
    return json;
}

// FUNKTIONSAUFRUF zum Abholen der json Daten über REST API und Erzeugung einer Tabelle
// Schritt 3: ausgepackte-json verarbeiten und nutzen für dynamischen Tabellenerzeugung  
function empfaenger2(json) {
	
		// Ermittlung Abzahl Objekte für Tabelle und Erzeugung entsprechender Anzahl Spalten
        var spalte = [];
        for (var i = 0; i < json.length; i++) {
            for (var key in json[i]) {
                if (spalte.indexOf(key) === -1) {
                    spalte.push(key);
                }
            }
        }

         // TABELLEN Überschriften erstellen aus den Variablennamen der Json
        var zeile = table.insertRow(-1);                   			// TABELLEN ZEILE.

        for (var i = 0; i < spalte.length; i++) {
            var ueberschrift = document.createElement("th");        // TABELLEN ÜBERSCHRIFT.
            ueberschrift.innerHTML = spalte[i];
            zeile.appendChild(ueberschrift);
        }
        
        // Hinzufügen notwendigen neuen Zeile
        for (var i = 0; i < json.length; i++) {
            zeile = table.insertRow(-1);

        	// Einfügen der Werte in die Zeile
            for (var j = 0; j < spalte.length; j++) {
                 	if (j == 2) {
                 		var tabellenZellen = zeile.insertCell(-1);
                 		var tempIBAN = json[i].empfaengerIBAN.iban;
                        tabellenZellen.innerHTML = json[i].empfaengerIBAN.iban;
                                                
                 	} else {
                 	 var tabellenZellen = zeile.insertCell(-1);
                	 tabellenZellen.innerHTML = json[i][spalte[j]];
            	 }
        	}
        	
        	// Erzeugen eines Links zum Aufruf der REST DELETE Methode über Link
            var link = json[i].id
            var tabellenZellen = zeile.insertCell(-1);
            tabellenZellen.innerHTML = '<a href = "#" onclick="loescheZelle('+link+');" title="delete">delete</a>';
          }
        
        // Erzeugte Tabelle mit den Daten aus Json Abruf in Div-Block ausgeben.
        var divContainer = document.getElementById("output");
        divContainer.innerHTML = "";
        divContainer.appendChild(table);
        
        }


// Abfragen aller Umsätze aus der Zahlungstabelle
function kontostand() {
        fetch("/umsatzDB")
        .then(empfaenger1)                 	// Aufruf der Methode empfaenger1 (auspacken der JSON)
        .then(empfaengerKonto2);            // Aufruf der Methode empfaenger2 (Setzen der ermittelten Werte in HTML)
}

// Funktion setzt die ermittelten Umsätze in der HTML Seite
function empfaengerKonto2(json) {
	document.getElementById("info").innerHTML = json
};

// Abfrage der Anzahl von Einträgen aus der DB
function anzahl() {
        fetch("/anzahlDB")
        .then(empfaenger1)                 	// Aufruf der Methode empfaenger1 (auspacken der JSON)
        .then(empfaengeranzahl2);           // Aufruf der Methode empfaenger2 (Setzen der ermittelten Werte in HTML)
}

// Funktion setzt die ermittelte Anzahl von Datensätzen als Wert in der HTML Seite
function empfaengeranzahl2(json) {
	document.getElementById("anzahl").innerHTML = json
	if (json == 1) {
		document.getElementById("anzahl2").innerHTML = "Datensatz"
	} else {
		document.getElementById("anzahl2").innerHTML = "Datensätze"
	}
};


function umsatzKategorieChartStart() {
	


}	
	

// Funktion kreiert ein Balkendiagramm mit Umsätzen pro Kategorie - NOCH NICHT LAUFFÄHIG
function umsatzKategorieChart() {
	
	// Einzelne Kategorien abfragen und Daten holen
	// Multible Fetch-Anfragen
	Promise.all([
		fetch("/freizeitUmsatzDB"),
		fetch("/kleidungUmsatzDB")
	]).then(function (responses) {
		// Get a JSON object from each of the responses
		return Promise.all(responses.map(function (response) {
			return response.json();
		}));
	}).then(function (data) {
		// bei dem zurückgegebenen data handelt es um ein Array

		
		var xValues = ["Freizeit", "Kleidung"];
		// Array für die Werte verwenden
		var yValues = data
		var barColors = ["red","green"];
	
		new Chart("myChart1", {
		  type: "bar",
		  data: {
		    labels: xValues,
		    datasets: [{
		      backgroundColor: barColors,
		      data: yValues
		    }]
		  },
		  options: {
			    legend: {display: false},
			    title: {
			      display: true,
			      text: "Umsätze nach Kategorien"
			    }
			  }
			});

	
	}).catch(function (error) {
		console.log(error);
	});
}


// Daten für Positv-/Negativumsatzchart
function chartEinAuszahlung() {
        fetch("/poneUmsatzDB")
        .then(empfaenger1)                 	// Aufruf der Methode empfaenger1 (auspacken der JSON)
        .then(poneUmsatz);        	 		// Aufruf der Methode empfaenger2 (Erstellung Kreisdiagramm)

}

//Funktion kreiert ein Kreisdiagramm mit positiven/negativen Umsätzen
function poneUmsatz(json) {

var positiv = json[0];	
var negativ = json[1] * -1;	 // negatives Vorzeichen mathematisch entfernen
	
var xValues = ["Zahlungseingänge", "Zahlungsausgänge"];
var yValues = [positiv, negativ];
var barColors = [
	"#00aba9",
	"#b91d47"  
	];

new Chart("myChart2", {
	  type: "pie",
	  data: {
	    labels: xValues,
	    datasets: [{
	      backgroundColor: barColors,
	      data: yValues
	    }]
	  },
	  options: {
	    title: {
	      display: true,
	      text: "Zahlungs Ein-/Ausgänge"
	    }
	  }
	})
};


// Autostart zahlreicher Methoden
anzahl();
kontostand();
chartEinAuszahlung();
umsatzKategorieChart();

</script>

</html>