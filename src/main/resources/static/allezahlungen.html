<!DOCTYPE html>
<html>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.5.0/Chart.min.js"></script>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="shortcut icon" type="image/x-icon" href="favicon.ico">
<link rel="stylesheet" href="myCSS.css" >
<!--   <script defer src="allezahlungen.js" type="module" type="text/javascript"></script>  -->



<style>
        th, td, p, input {
            font:14px Verdana;
        }
        table, th, td 
        {
            border: solid 1px #DDD;
            border-collapse: collapse;
            padding: 2px 3px;
            text-align: center;
        }
        th {
            font-weight:bold;
        }
    </style>
<title>Web-Banking</title>
</head>

<header id="header" class="floatbox">
	<div id="header-content">
  	<p>this tool is made with <img src="heart.png" alt="love" width="25" height="25"/> by SEA </p>
  	</div>
</header>

<body>

<div class="sidenav">
  <h2>Web-Banking</h2>
  <br/>
  <a href="/index.html">Home</a>
  <a href="/neuezahlung.html">Neue Zahlung</a>
  <a href="/einzelabfrage.html">Einzelabfrage</a>
  <a href="/allezahlungen.html">Übersicht Transaktionen</a>
  <a href="/testdaten.html">Zahlungen generieren</a>
  <!-- <a href="/?kdnr=1234">Login Kd.1</a> -->
  <!-- <a href="/?kdnr=2345">Login Kd.2</a> -->
  <a href="#tbd">Credits</a>
</div>

<div class="main">
	<br/>
    <h3>Übersicht Zahlungen</h3>
    <p>Eine Übersicht über all deine Transaktionen.</p>
    <p>Kontostand/Umsatz: <span id="info"> KLICKE <button id="btnK" type="button">CHECK</button>! </span> Euro.</p>
    <input type="button" id="table" value="Zahlungen laden" />
    <br/>
    <button onclick="window.location.href='/allezahlungen.html'">Reset</button>
    <button id="btnK" type="button">New Check</button>
    <button id="btnC" type="button">Chart Refresh</button>
	<br/>
	<br/>
	<div id=output></div>
	<br/>
	<br/>
	<canvas id="myChart" style="width:100%;max-width:700px"></canvas>
</div> 
</body>

<script>

//Sammlung von Listener
document.getElementById("table").addEventListener("click", tabelleAusJson);
document.getElementById("btnK").addEventListener("click", kontostand);
document.getElementById("btnC").addEventListener("click", chart);

// VARIABLE MIT DYNAMISCHE TABELLE ERZEUGEN
var table = document.createElement("table");

// FUNKTIONSAUFRUF zum senden eines DELETE an WEBSERVER und entfernen der Zeile aus der Tabelle
function loescheZelle(i) {
	fetch("/zahlung/" + i,
			{
				headers: {"Content-Type":"application/json"},
				method: "DELETE",
				body: ""
			}
			).then(alert("Danke für die Nutzung unseres Webservices! Es wurden Ihnen Gebühren in Höhe von 0,05 Euro in Rechnung gestellt!"))
	
			zeile = table.deleteRow(i+1);

}

// FUNKTIONSAUFRUF zum abholen der json Daten über REST API und Erzeugung einer Tabelle
// Schritt 1: Vorbereitung des Abrufs und abholen der json
function tabelleAusJson() {
        var jsonURL = "/zahlungen/"			// URL zum Abfragen - REST API Get aus Java
        fetch(jsonURL)						// JSON abrufen
        .then(empfaenger1)
        .then(empfaenger2)
    }

// FUNKTIONSAUFRUF zum abholen der json Daten über REST API und Erzeugung einer Tabelle
// Schritt 2: Auspacken der json und als Array weiterreichen   
function empfaenger1(antwort) {
    var json = antwort.json();  			// Datenpaket auspacken
    return json;                			// Datenpaket zurückgeben an Aufrufer der Funktion
}

// FUNKTIONSAUFRUF zum abholen der json Daten über REST API und Erzeugung einer Tabelle
// Schritt 3: ex-json als Array verwenden um dynamisch eine Tabelle zu erzeugen  
function empfaenger2(json) {
	
        var spalte = [];
        for (var i = 0; i < json.zahlungen.length; i++) {
            for (var key in json.zahlungen[i]) {
                if (spalte.indexOf(key) === -1) {
                    spalte.push(key);
                }
            }
        }

         // TABELLEN Überschriften erstellen aus den Variablennamen der Json
        var zeile = table.insertRow(-1);                   			// TABELLEN ZEILE.

        for (var i = 0; i < spalte.length; i++) {
            var ueberschrift = document.createElement("th");        // TABELLEN ÜBERSCHRIFT.
            ueberschrift.innerHTML = spalte[i];
            zeile.appendChild(ueberschrift);
        }
        
        // Hinzufügen der Daten aus Json als Zeilen
        for (var i = 0; i < json.zahlungen.length; i++) {
            zeile = table.insertRow(-1);

            for (var j = 0; j < spalte.length; j++) {
                var tabellenZellen = zeile.insertCell(-1);
                tabellenZellen.innerHTML = json.zahlungen[i][spalte[j]];
                 }
                 // Erzeugen eines Links zum Aufruf der REST DELETE Methode über Link
                 var tabellenZellen = zeile.insertCell(-1);
                 tabellenZellen.innerHTML = '<a href = "#" onclick="loescheZelle('+i+');" title="delete">delete</a>';
          }

        // Erzeugte Tabelle mit den Daten aus Json Abruf in Div-Block ausgeben.
        var divContainer = document.getElementById("output");
        divContainer.innerHTML = "";
        divContainer.appendChild(table);
        }
    
function kontostand() {
    var jsonURL = "infoUmsatz/";
	// Verarbeitung
        fetch(jsonURL)
        .then(empfaenger1)                 	// Aufruf der Methode empfaenger1
        .then(empfaengerKonto2);                // Aufruf der Methode empfaenger2
}

function empfaengerKonto2(json) {
	document.getElementById("info").innerHTML = json
};


function chart() {
    var jsonURL = "infoChart/";
	// Verarbeitung
        fetch(jsonURL)
        .then(empfaenger1)                 	// Aufruf der Methode empfaenger1
        .then(empfaengerchart2);                // Aufruf der Methode empfaenger2
}

function empfaengerchart2(json) {

	var umsatzPeggy 	= json.Peggy; 
    var umsatzFranzi	= json.Franzi; 
    var umsatzOli		= json.Oli;
    var umsatzMarco		= json.Marco;
    var umsatzElisabeth	= json.Elisabeth;
    var umsatzThorsten	= json.Thorsten;
    var umsatzRobert	= json.Robert;
    var umsatzMichael	= json.Michael;
	
var xValues = ["Peggy", "Franzi", "Oli", "Marco", "Elisabeth" , "Thorsten", "Robert", "Michael"];
var yValues = [umsatzPeggy, umsatzFranzi, umsatzOli, umsatzMarco, umsatzElisabeth, umsatzThorsten, umsatzRobert, umsatzMichael];

	
var barColors = ["red","green","yellow", "blue", "orange", "red", "green", "yellow"];

new Chart("myChart", {
  type: "bar",
  data: {
    labels: xValues,
    datasets: [{
      backgroundColor: barColors,
      data: yValues
    }]
  },
  options: {
	    legend: {display: false},
	    title: {
	      display: true,
	      text: "Umsätze nach Personen"
	    }
	  }
	});
	
};
</script>



</html>